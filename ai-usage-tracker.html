<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Usage Tracker - Monitor de Consumo IA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .session-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: bold;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #999;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .input-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        input[type="number"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff3838;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .history-section, .stats-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .history-section h2, .stats-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        .history-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .history-table tbody tr:hover {
            background: #f8f8ff;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }

        .chart {
            width: 100%;
            position: relative;
            overflow: visible;
        }

        .chart svg {
            display: block;
            width: 100%;
            height: auto;
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            white-space: nowrap;
        }

        .chart-tooltip.active {
            opacity: 1;
        }

        .chart-point {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-point:hover {
            r: 7;
            filter: brightness(1.2);
        }

        .session-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .history-table {
                font-size: 0.9em;
            }

            .history-table th,
            .history-table td {
                padding: 10px 5px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                min-height: 150px;
            }

            .chart svg {
                max-height: 200px;
            }
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .delete-btn:hover {
            background: #ff3838;
        }

        .mini-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .mini-stat-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .mini-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Usage Tracker</h1>
            <p class="subtitle">Monitor de Consumo de Modelo IA - 8h/d√≠a (4.1‚Ç¨/d√≠a, 0.5‚Ç¨/h)</p>
            <div class="session-indicator" id="sessionIndicator">Sesi√≥n 1 de 2</div>
        </header>

        <div id="alertContainer"></div>

        <div class="dashboard">
            <div class="stat-card">
                <h3>Uso Sesi√≥n Actual (5h)</h3>
                <div class="stat-value" id="totalUsage">0.00%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>
            </div>

            <div class="stat-card">
                <h3>Coste Diario Total</h3>
                <div class="stat-value" id="totalCost">0.00‚Ç¨</div>
                <div class="stat-label">de 4.10‚Ç¨/d√≠a (8h)</div>
            </div>

            <div class="stat-card">
                <h3>Coste Medio/Prompt</h3>
                <div class="stat-value" id="avgCostPerPrompt">0.000‚Ç¨</div>
                <div class="stat-label">todas las sesiones</div>
            </div>

            <div class="stat-card">
                <h3>Total Prompts Hoy</h3>
                <div class="stat-value" id="totalPrompts">0</div>
                <div class="stat-label">todas las sesiones</div>
            </div>

            <div class="stat-card">
                <h3>Uso Medio/Prompt</h3>
                <div class="stat-value" id="avgPerPrompt">0.00%</div>
                <div class="stat-label">sesi√≥n actual</div>
            </div>

            <div class="stat-card">
                <h3>Prompts/Hora</h3>
                <div class="stat-value" id="promptsPerHour">0</div>
                <div class="stat-label">estimados</div>
            </div>

            <div class="stat-card">
                <h3>Minutos/Prompt</h3>
                <div class="stat-value" id="minutesPerPrompt">0</div>
                <div class="stat-label">disponible cada</div>
            </div>
        </div>

        <div class="input-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">Registrar Nuevo Prompt</h2>
            <form id="promptForm">
                <div class="form-group">
                    <label for="currentUsage">Porcentaje de Uso Actual (%):</label>
                    <input
                        type="number"
                        id="currentUsage"
                        step="0.01"
                        min="0"
                        max="100"
                        placeholder="Ej: 15.5"
                        required
                    >
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn-primary">Registrar Prompt</button>
                    <button type="button" class="btn-secondary" onclick="resetSession()">Nueva Sesi√≥n (5h)</button>
                    <button type="button" class="btn-danger" onclick="endDay()">Acabar el D√≠a</button>
                </div>
            </form>
        </div>

        <div class="history-section">
            <h2>Hist√≥rico de Prompts - Sesi√≥n Actual</h2>
            <div style="overflow-x: auto;">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha/Hora</th>
                            <th>Uso Acumulado</th>
                            <th>Consumo Prompt</th>
                            <th>Coste Prompt</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div>
                                    <p style="font-size: 1.2em;">No hay prompts registrados en esta sesi√≥n</p>
                                    <p>Introduce el porcentaje de uso actual para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECCI√ìN: Estad√≠sticas del D√≠a Actual -->
        <div class="stats-section" id="todayStatsSection">
            <h2>üìä Estad√≠sticas del D√≠a Actual</h2>
            <div id="todayStatsContent"></div>
        </div>

        <!-- Estad√≠sticas Semanales -->
        <div class="stats-section" id="weeklyStatsSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìà Estad√≠sticas Semanales (√öltimos 7 d√≠as)</h2>
                <button class="btn-success" onclick="exportWeeklyData()" style="min-width: auto; flex: none;">
                    üíæ Exportar Datos
                </button>
            </div>
            <div id="weeklyStatsContent"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n: 4.1‚Ç¨/d√≠a para 8h de uso, el uso se mide en sesiones de 5h
        const COST_PER_DAY = 4.1;
        const COST_PER_HOUR = 0.5;
        const HOURS_PER_DAY = 8;
        const USAGE_HOURS = 5;
        const COST_PER_PERCENT = COST_PER_HOUR / 100;

        // Estado actual
        let currentSessionNumber = parseInt(localStorage.getItem('currentSessionNumber')) || 1;
        let currentSessionPrompts = JSON.parse(localStorage.getItem('currentSessionPrompts')) || [];
        let lastUsage = parseFloat(localStorage.getItem('lastUsage')) || 0;
        let dailyCost = parseFloat(localStorage.getItem('dailyCost')) || 0;
        let completedSessions = JSON.parse(localStorage.getItem('completedSessions')) || [];
        let dailyHistory = JSON.parse(localStorage.getItem('dailyHistory')) || [];

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        function updateDashboard() {
            let allPromptsToday = [...currentSessionPrompts];
            completedSessions.forEach(session => {
                allPromptsToday = allPromptsToday.concat(session.prompts);
            });

            const totalUsageCurrentSession = lastUsage;
            const totalCost = dailyCost;
            const totalPromptsToday = allPromptsToday.length;
            const totalPromptsCurrentSession = currentSessionPrompts.length;

            let avgPerPrompt = 0;
            let avgCostPerPrompt = 0;
            let promptsPerHour = 0;
            let minutesPerPrompt = 0;

            if (totalPromptsCurrentSession > 0) {
                avgPerPrompt = totalUsageCurrentSession / totalPromptsCurrentSession;
                if (avgPerPrompt > 0) {
                    // Basado en 5h (300 min): si uso medio es X%, puedes hacer 100/X prompts en 5h
                    const totalPromptsIn5h = 100 / avgPerPrompt;
                    promptsPerHour = Math.floor(totalPromptsIn5h / 5);
                    minutesPerPrompt = (300 / totalPromptsIn5h).toFixed(1);
                }
            }

            if (totalPromptsToday > 0) {
                avgCostPerPrompt = totalCost / totalPromptsToday;
            }

            document.getElementById('totalUsage').textContent = totalUsageCurrentSession.toFixed(2) + '%';
            document.getElementById('totalCost').textContent = totalCost.toFixed(2) + '‚Ç¨';
            document.getElementById('avgCostPerPrompt').textContent = avgCostPerPrompt.toFixed(3) + '‚Ç¨';
            document.getElementById('totalPrompts').textContent = totalPromptsToday;
            document.getElementById('avgPerPrompt').textContent = avgPerPrompt.toFixed(2) + '%';
            document.getElementById('promptsPerHour').textContent = promptsPerHour;
            document.getElementById('minutesPerPrompt').textContent = minutesPerPrompt;

            document.getElementById('sessionIndicator').textContent = `Sesi√≥n ${currentSessionNumber} de 2`;

            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = Math.min(totalUsageCurrentSession, 100) + '%';
            progressBar.textContent = totalUsageCurrentSession.toFixed(1) + '%';

            if (totalUsageCurrentSession > 90) {
                progressBar.style.background = 'linear-gradient(90deg, #ff4757 0%, #ff3838 100%)';
            } else if (totalUsageCurrentSession > 70) {
                progressBar.style.background = 'linear-gradient(90deg, #ffa502 0%, #ff6348 100%)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
            }
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');

            if (currentSessionPrompts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div>
                                <p style="font-size: 1.2em;">No hay prompts registrados en esta sesi√≥n</p>
                                <p>Introduce el porcentaje de uso actual para comenzar</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = currentSessionPrompts.map((prompt, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${new Date(prompt.timestamp).toLocaleString('es-ES')}</td>
                    <td><strong>${prompt.usage.toFixed(2)}%</strong></td>
                    <td>${prompt.consumed.toFixed(2)}%</td>
                    <td>${prompt.cost.toFixed(3)}‚Ç¨</td>
                    <td>
                        <button class="delete-btn" onclick="deletePrompt(${index})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function createLineChart(data, labels, title, color = '#667eea', suffix = '') {
            if (!data || data.length === 0) return '<p class="empty-state">No hay datos suficientes</p>';

            const chartId = 'chart-' + Math.random().toString(36).substr(2, 9);
            const width = 600;
            const height = 250;
            const padding = 60; // Aumentado para dar espacio a las etiquetas

            const maxValue = Math.max(...data, 1);
            const minValue = Math.min(...data, 0);
            const range = maxValue - minValue || 1;

            // Calcular posiciones de los puntos
            const points = data.map((value, index) => {
                const x = padding + (index / (data.length - 1 || 1)) * (width - 2 * padding);
                const y = height - padding - ((value - minValue) / range) * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');

            // Puntos interactivos
            const circles = data.map((value, index) => {
                const x = padding + (index / (data.length - 1 || 1)) * (width - 2 * padding);
                const y = height - padding - ((value - minValue) / range) * (height - 2 * padding);
                const displayValue = value.toFixed(2) + suffix;
                const label = labels && labels[index] ? labels[index] : `Punto ${index + 1}`;
                return `<circle class="chart-point" cx="${x}" cy="${y}" r="5" fill="${color}"
                    onmouseover="showTooltip(event, '${label}: ${displayValue}')"
                    onmouseout="hideTooltip()" />`;
            }).join('');

            // Eje Y - etiquetas
            const yAxisLabels = [];
            const numYTicks = 5;
            for (let i = 0; i <= numYTicks; i++) {
                const value = minValue + (range * i / numYTicks);
                const y = height - padding - (i / numYTicks) * (height - 2 * padding);
                yAxisLabels.push(`
                    <text x="${padding - 10}" y="${y}" text-anchor="end" font-size="10" fill="#666" dominant-baseline="middle">
                        ${value.toFixed(1)}${suffix}
                    </text>
                    <line x1="${padding - 5}" y1="${y}" x2="${padding}" y2="${y}" stroke="#999" stroke-width="1" />
                `);
            }

            // Eje X - etiquetas (mostramos algunas etiquetas seleccionadas)
            const xAxisLabels = [];
            const numXTicks = Math.min(data.length, 5); // M√°ximo 5 etiquetas
            const xStep = Math.floor((data.length - 1) / (numXTicks - 1 || 1)) || 1;
            for (let i = 0; i < data.length; i += xStep) {
                const x = padding + (i / (data.length - 1 || 1)) * (width - 2 * padding);
                const label = labels && labels[i] ? labels[i] : i + 1;
                xAxisLabels.push(`
                    <text x="${x}" y="${height - padding + 20}" text-anchor="middle" font-size="10" fill="#666">
                        ${label}
                    </text>
                    <line x1="${x}" y1="${height - padding}" x2="${x}" y2="${height - padding + 5}" stroke="#999" stroke-width="1" />
                `);
            }

            return `
                <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="width: 100%; height: auto; max-height: 200px;">
                    <!-- Ejes -->
                    <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#999" stroke-width="2" />
                    <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#999" stroke-width="2" />

                    <!-- Etiquetas eje Y -->
                    ${yAxisLabels.join('')}

                    <!-- Etiquetas eje X -->
                    ${xAxisLabels.join('')}

                    <!-- L√≠nea de datos -->
                    <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2.5" />

                    <!-- Puntos interactivos -->
                    ${circles}
                </svg>
            `;
        }

        function showTooltip(event, text) {
            const tooltip = document.querySelector('.chart-tooltip');
            if (!tooltip) {
                const newTooltip = document.createElement('div');
                newTooltip.className = 'chart-tooltip';
                newTooltip.textContent = text;
                document.body.appendChild(newTooltip);

                newTooltip.style.left = (event.pageX + 10) + 'px';
                newTooltip.style.top = (event.pageY - 30) + 'px';
                setTimeout(() => newTooltip.classList.add('active'), 10);
            } else {
                tooltip.textContent = text;
                tooltip.style.left = (event.pageX + 10) + 'px';
                tooltip.style.top = (event.pageY - 30) + 'px';
                tooltip.classList.add('active');
            }
        }

        function hideTooltip() {
            const tooltip = document.querySelector('.chart-tooltip');
            if (tooltip) {
                tooltip.classList.remove('active');
            }
        }

        function updateTodayStats() {
            const content = document.getElementById('todayStatsContent');

            let allPromptsToday = [...currentSessionPrompts];
            completedSessions.forEach(session => {
                allPromptsToday = allPromptsToday.concat(session.prompts);
            });

            if (allPromptsToday.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>No hay prompts registrados hoy. Comienza a registrar para ver las estad√≠sticas.</p></div>';
                return;
            }

            // Calcular estad√≠sticas del d√≠a
            const totalUsageToday = completedSessions.reduce((sum, s) => sum + s.totalUsage, 0) + lastUsage;
            const totalCostToday = dailyCost;
            const totalPromptsToday = allPromptsToday.length;
            const avgUsagePerPrompt = totalUsageToday / totalPromptsToday;
            const avgCostPerPrompt = totalCostToday / totalPromptsToday;
            // Basado en 5h (300 min): si uso medio es X%, puedes hacer 100/X prompts en 5h
            const totalPromptsIn5h = avgUsagePerPrompt > 0 ? 100 / avgUsagePerPrompt : 0;
            const promptsPerHour = avgUsagePerPrompt > 0 ? Math.floor(totalPromptsIn5h / 5) : 0;
            const minutesPerPrompt = totalPromptsIn5h > 0 ? (300 / totalPromptsIn5h).toFixed(1) : 0;

            // Datos para gr√°ficos (evoluci√≥n temporal)
            const usageOverTime = [];
            const costOverTime = [];
            const timeLabels = [];
            let cumulativeUsage = 0;
            let cumulativeCost = 0;

            allPromptsToday.forEach((prompt, index) => {
                cumulativeUsage += prompt.consumed;
                cumulativeCost += prompt.cost;
                usageOverTime.push(cumulativeUsage);
                costOverTime.push(cumulativeCost);
                timeLabels.push(`Prompt ${index + 1}`);
            });

            let html = `
                <div class="stats-grid">
                    <div class="mini-stat">
                        <div class="mini-stat-label">Uso Total Hoy</div>
                        <div class="mini-stat-value">${totalUsageToday.toFixed(2)}%</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Coste Total Hoy</div>
                        <div class="mini-stat-value">${totalCostToday.toFixed(2)}‚Ç¨</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Total Prompts</div>
                        <div class="mini-stat-value">${totalPromptsToday}</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">% Medio/Prompt</div>
                        <div class="mini-stat-value">${avgUsagePerPrompt.toFixed(2)}%</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Coste Medio/Prompt</div>
                        <div class="mini-stat-value">${avgCostPerPrompt.toFixed(3)}‚Ç¨</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Prompts/Hora</div>
                        <div class="mini-stat-value">${promptsPerHour}</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Minutos/Prompt</div>
                        <div class="mini-stat-value">${minutesPerPrompt} min</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Sesiones Hoy</div>
                        <div class="mini-stat-value">${completedSessions.length + 1}</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="chart-container">
                        <div class="chart-title">Evoluci√≥n de Uso (%) - Hover para detalles</div>
                        <div class="chart">${createLineChart(usageOverTime, timeLabels, 'Uso', '#667eea', '%')}</div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Evoluci√≥n de Coste (‚Ç¨) - Hover para detalles</div>
                        <div class="chart">${createLineChart(costOverTime, timeLabels, 'Coste', '#2ecc71', '‚Ç¨')}</div>
                    </div>
                </div>
            `;

            content.innerHTML = html;
        }

        function updateWeeklyStats() {
            const content = document.getElementById('weeklyStatsContent');

            // Verificar si hay datos del d√≠a actual
            let allPromptsToday = [...currentSessionPrompts];
            completedSessions.forEach(session => {
                allPromptsToday = allPromptsToday.concat(session.prompts);
            });

            const hasTodayData = allPromptsToday.length > 0;

            // Si no hay historial NI datos de hoy, mostrar mensaje
            if (dailyHistory.length === 0 && !hasTodayData) {
                content.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 1.2em;">üìÖ A√∫n no hay historial semanal</p>
                        <p>Registra algunos prompts para comenzar a ver las estad√≠sticas.</p>
                        <p style="margin-top: 10px; color: #667eea;">Los datos del d√≠a actual aparecer√°n aqu√≠ autom√°ticamente.</p>
                    </div>
                `;
                return;
            }

            // Crear array combinado: historial + d√≠a actual (si hay datos)
            let allDays = [...dailyHistory];

            if (hasTodayData) {
                // Crear objeto del d√≠a actual para incluirlo en las estad√≠sticas
                let allSessionsToday = [...completedSessions];
                if (currentSessionPrompts.length > 0) {
                    allSessionsToday.push({
                        sessionNumber: currentSessionNumber,
                        totalUsage: lastUsage,
                        prompts: currentSessionPrompts
                    });
                }

                const totalUsageToday = allSessionsToday.reduce((sum, s) => sum + s.totalUsage, 0);

                const todayData = {
                    date: new Date().toISOString().split('T')[0],
                    totalCost: dailyCost,
                    totalPrompts: allPromptsToday.length,
                    avgCostPerPrompt: allPromptsToday.length > 0 ? dailyCost / allPromptsToday.length : 0,
                    sessions: allSessionsToday,
                    isToday: true // Marcador para identificarlo
                };

                // Agregar al inicio (d√≠a m√°s reciente)
                allDays.unshift(todayData);
            }

            // Calcular estad√≠sticas semanales (usando allDays que incluye hoy)
            const totalWeeklyCost = allDays.reduce((sum, day) => sum + day.totalCost, 0);
            const totalWeeklyPrompts = allDays.reduce((sum, day) => sum + day.totalPrompts, 0);
            const avgDailyCost = totalWeeklyCost / allDays.length;
            const avgDailyPrompts = totalWeeklyPrompts / allDays.length;

            // Calcular promedios
            let totalAvgUsagePerPrompt = 0;
            let totalPromptsPerHour = 0;
            let totalMinutesPerPrompt = 0;
            let daysWithData = 0;

            allDays.forEach(day => {
                if (day.totalPrompts > 0) {
                    const totalUsageDay = day.sessions.reduce((sum, s) => sum + s.totalUsage, 0);
                    const avgUsage = totalUsageDay / day.totalPrompts;
                    totalAvgUsagePerPrompt += avgUsage;

                    if (avgUsage > 0) {
                        // Basado en 5h (300 min): si uso medio es X%, puedes hacer 100/X prompts en 5h
                        const totalPromptsIn5h = 100 / avgUsage;
                        const pph = totalPromptsIn5h / 5;
                        totalPromptsPerHour += pph;
                        totalMinutesPerPrompt += (300 / totalPromptsIn5h);
                    }
                    daysWithData++;
                }
            });

            const weeklyAvgUsagePerPrompt = daysWithData > 0 ? totalAvgUsagePerPrompt / daysWithData : 0;
            const weeklyAvgPromptsPerHour = daysWithData > 0 ? totalPromptsPerHour / daysWithData : 0;
            const weeklyAvgMinutesPerPrompt = daysWithData > 0 ? totalMinutesPerPrompt / daysWithData : 0;

            // Datos para gr√°ficos semanales
            const dailyCosts = allDays.map(d => d.totalCost).reverse();
            const dailyPrompts = allDays.map(d => d.totalPrompts).reverse();
            const dailyAvgCost = allDays.map(d => d.avgCostPerPrompt).reverse();
            const dailyAvgUsage = allDays.map(d => {
                const totalUsage = d.sessions.reduce((sum, s) => sum + s.totalUsage, 0);
                return d.totalPrompts > 0 ? totalUsage / d.totalPrompts : 0;
            }).reverse();

            const dayLabels = allDays.map((d, i) => {
                const date = new Date(d.date);
                const label = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                return d.isToday ? 'Hoy' : label;
            }).reverse();

            let html = `
                <div class="stats-grid">
                    <div class="mini-stat">
                        <div class="mini-stat-label">Coste Total Semanal</div>
                        <div class="mini-stat-value">${totalWeeklyCost.toFixed(2)}‚Ç¨</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Prompts Totales</div>
                        <div class="mini-stat-value">${totalWeeklyPrompts}</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Coste Medio/D√≠a</div>
                        <div class="mini-stat-value">${avgDailyCost.toFixed(2)}‚Ç¨</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Prompts Medio/D√≠a</div>
                        <div class="mini-stat-value">${avgDailyPrompts.toFixed(1)}</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">% Medio/Prompt</div>
                        <div class="mini-stat-value">${weeklyAvgUsagePerPrompt.toFixed(2)}%</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Prompts/Hora Promedio</div>
                        <div class="mini-stat-value">${weeklyAvgPromptsPerHour.toFixed(1)}</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">Minutos/Prompt Promedio</div>
                        <div class="mini-stat-value">${weeklyAvgMinutesPerPrompt.toFixed(1)} min</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-label">D√≠as Registrados</div>
                        <div class="mini-stat-value">${allDays.length}</div>
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 30px 0 15px 0;">üìä Gr√°ficos de Evoluci√≥n (Hover para detalles)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="chart-container">
                        <div class="chart-title">Evoluci√≥n Coste Diario (‚Ç¨)</div>
                        <div class="chart">${createLineChart(dailyCosts, dayLabels, 'Coste', '#667eea', '‚Ç¨')}</div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Evoluci√≥n Prompts Diarios</div>
                        <div class="chart">${createLineChart(dailyPrompts, dayLabels, 'Prompts', '#2ecc71', '')}</div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Evoluci√≥n % Medio por Prompt</div>
                        <div class="chart">${createLineChart(dailyAvgUsage, dayLabels, 'Uso %', '#ffa502', '%')}</div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Evoluci√≥n Coste Medio/Prompt (‚Ç¨)</div>
                        <div class="chart">${createLineChart(dailyAvgCost, dayLabels, 'Coste', '#ff6348', '‚Ç¨')}</div>
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 30px 0 15px 0;">üìÖ Desglose por D√≠a</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            `;

            allDays.forEach(day => {
                const date = new Date(day.date);
                const dayName = day.isToday ? 'üîµ HOY' : date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const totalUsageDay = day.sessions.reduce((sum, s) => sum + s.totalUsage, 0);
                const avgUsageDay = day.totalPrompts > 0 ? totalUsageDay / day.totalPrompts : 0;
                const borderColor = day.isToday ? '#2ecc71' : '#667eea';
                const bgColor = day.isToday ? '#e8f8f0' : '#f8f9ff';

                html += `
                    <div style="background: ${bgColor}; padding: 20px; border-radius: 10px; border-left: 4px solid ${borderColor};">
                        <h4 style="color: ${borderColor}; margin-bottom: 10px;">${dayName} <span class="session-badge">${day.sessions.length} sesiones</span></h4>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; color: #666;">
                            <span>Coste Total:</span>
                            <strong style="color: #333;">${day.totalCost.toFixed(2)}‚Ç¨</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; color: #666;">
                            <span>Total Prompts:</span>
                            <strong style="color: #333;">${day.totalPrompts}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; color: #666;">
                            <span>Coste Medio/Prompt:</span>
                            <strong style="color: #333;">${day.avgCostPerPrompt.toFixed(3)}‚Ç¨</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; color: #666;">
                            <span>% Medio/Prompt:</span>
                            <strong style="color: #333;">${avgUsageDay.toFixed(2)}%</strong>
                        </div>
                `;

                day.sessions.forEach(session => {
                    html += `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                                <span><strong>Sesi√≥n ${session.sessionNumber}:</strong></span>
                                <span>${session.prompts.length} prompts</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                                <span>Uso Total:</span>
                                <strong style="color: #333;">${session.totalUsage.toFixed(2)}%</strong>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function deletePrompt(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este prompt?')) {
                currentSessionPrompts.splice(index, 1);

                if (currentSessionPrompts.length > 0) {
                    lastUsage = currentSessionPrompts[currentSessionPrompts.length - 1].usage;
                    dailyCost = currentSessionPrompts.reduce((sum, p) => sum + p.cost, 0);
                    completedSessions.forEach(session => {
                        dailyCost += session.prompts.reduce((sum, p) => sum + p.cost, 0);
                    });
                } else {
                    lastUsage = 0;
                    dailyCost = 0;
                    completedSessions.forEach(session => {
                        dailyCost += session.prompts.reduce((sum, p) => sum + p.cost, 0);
                    });
                }

                saveData();
                updateAll();
                showAlert('Prompt eliminado correctamente', 'success');
            }
        }

        document.getElementById('promptForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const currentUsage = parseFloat(document.getElementById('currentUsage').value);

            if (isNaN(currentUsage) || currentUsage < 0 || currentUsage > 100) {
                showAlert('Por favor, introduce un porcentaje v√°lido entre 0 y 100', 'danger');
                return;
            }

            if (currentUsage < lastUsage) {
                showAlert('El porcentaje actual no puede ser menor al anterior (' + lastUsage.toFixed(2) + '%)', 'warning');
                return;
            }

            const consumed = currentUsage - lastUsage;
            const cost = consumed * COST_PER_PERCENT;

            const newPrompt = {
                timestamp: new Date().toISOString(),
                usage: currentUsage,
                consumed: consumed,
                cost: cost
            };

            currentSessionPrompts.push(newPrompt);
            lastUsage = currentUsage;
            dailyCost += cost;

            saveData();
            updateAll();

            // LIMPIAR EL CAMPO DESPU√âS DE REGISTRAR
            document.getElementById('currentUsage').value = '';
            document.getElementById('currentUsage').focus();

            showAlert(`Prompt registrado: ${consumed.toFixed(2)}% consumido (${cost.toFixed(3)}‚Ç¨)`, 'success');
        });

        function saveData() {
            localStorage.setItem('currentSessionNumber', currentSessionNumber.toString());
            localStorage.setItem('currentSessionPrompts', JSON.stringify(currentSessionPrompts));
            localStorage.setItem('lastUsage', lastUsage.toString());
            localStorage.setItem('dailyCost', dailyCost.toString());
            localStorage.setItem('completedSessions', JSON.stringify(completedSessions));
            localStorage.setItem('dailyHistory', JSON.stringify(dailyHistory));
        }

        function resetSession() {
            if (currentSessionPrompts.length === 0) {
                showAlert('No hay datos en la sesi√≥n actual para guardar', 'warning');
                return;
            }

            if (confirm('¬øIniciar nueva sesi√≥n? Esto guardar√° la sesi√≥n actual internamente y comenzar√° una nueva sesi√≥n de 5h.')) {
                const sessionData = {
                    sessionNumber: currentSessionNumber,
                    startTime: currentSessionPrompts[0].timestamp,
                    endTime: currentSessionPrompts[currentSessionPrompts.length - 1].timestamp,
                    totalUsage: lastUsage,
                    prompts: currentSessionPrompts
                };

                completedSessions.push(sessionData);

                currentSessionNumber++;
                currentSessionPrompts = [];
                lastUsage = 0;

                saveData();
                updateAll();

                showAlert(`Sesi√≥n ${sessionData.sessionNumber} guardada. Ahora en Sesi√≥n ${currentSessionNumber}. Coste diario: ${dailyCost.toFixed(2)}‚Ç¨`, 'success');
            }
        }

        function endDay() {
            const hasCurrentSessionData = currentSessionPrompts.length > 0;
            const hasCompletedSessions = completedSessions.length > 0;

            if (!hasCurrentSessionData && !hasCompletedSessions && dailyCost === 0) {
                showAlert('No hay datos para guardar del d√≠a de hoy', 'warning');
                return;
            }

            if (confirm('¬øAcabar el d√≠a? Esto guardar√° todas las sesiones de hoy en las estad√≠sticas semanales y comenzar√° un nuevo d√≠a.')) {
                let allSessions = [...completedSessions];
                if (hasCurrentSessionData) {
                    const currentSessionData = {
                        sessionNumber: currentSessionNumber,
                        startTime: currentSessionPrompts[0].timestamp,
                        endTime: currentSessionPrompts[currentSessionPrompts.length - 1].timestamp,
                        totalUsage: lastUsage,
                        prompts: currentSessionPrompts
                    };
                    allSessions.push(currentSessionData);
                }

                let allPromptsDay = [];
                allSessions.forEach(session => {
                    allPromptsDay = allPromptsDay.concat(session.prompts);
                });

                const today = new Date().toISOString().split('T')[0];

                const dayData = {
                    date: today,
                    totalCost: dailyCost,
                    totalPrompts: allPromptsDay.length,
                    avgCostPerPrompt: allPromptsDay.length > 0 ? dailyCost / allPromptsDay.length : 0,
                    sessions: allSessions
                };

                dailyHistory.unshift(dayData);
                if (dailyHistory.length > 7) {
                    dailyHistory = dailyHistory.slice(0, 7);
                }

                currentSessionNumber = 1;
                currentSessionPrompts = [];
                lastUsage = 0;
                dailyCost = 0;
                completedSessions = [];

                saveData();
                updateAll();

                showAlert(`D√≠a finalizado. ${allSessions.length} sesiones guardadas con ${allPromptsDay.length} prompts totales. ¬°Nuevo d√≠a comenzado!`, 'success');
            }
        }

        function exportWeeklyData() {
            if (dailyHistory.length === 0) {
                showAlert('No hay datos para exportar', 'warning');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                summary: {
                    totalDays: dailyHistory.length,
                    totalCost: dailyHistory.reduce((sum, day) => sum + day.totalCost, 0),
                    totalPrompts: dailyHistory.reduce((sum, day) => sum + day.totalPrompts, 0),
                    avgDailyCost: dailyHistory.reduce((sum, day) => sum + day.totalCost, 0) / dailyHistory.length,
                    avgDailyPrompts: dailyHistory.reduce((sum, day) => sum + day.totalPrompts, 0) / dailyHistory.length
                },
                dailyData: dailyHistory
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-usage-stats-${new Date().toISOString().split('T')[0]}.json`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showAlert('Datos exportados correctamente en formato JSON', 'success');
        }

        function updateAll() {
            updateDashboard();
            updateHistoryTable();
            updateTodayStats();
            updateWeeklyStats();
        }

        // Inicializar la aplicaci√≥n
        updateAll();
    </script>
</body>
</html>
