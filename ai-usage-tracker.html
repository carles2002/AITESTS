<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Usage Tracker - Monitor de Consumo IA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .session-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: bold;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #999;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .input-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        input[type="number"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff3838;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .history-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .history-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        .history-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .history-table tbody tr:hover {
            background: #f8f8ff;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .weekly-stats {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .weekly-stats h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .day-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .day-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .day-stat {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            color: #666;
        }

        .day-stat strong {
            color: #333;
        }

        .session-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .history-table {
                font-size: 0.9em;
            }

            .history-table th,
            .history-table td {
                padding: 10px 5px;
            }

            .weekly-grid {
                grid-template-columns: 1fr;
            }
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .delete-btn:hover {
            background: #ff3838;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Usage Tracker</h1>
            <p class="subtitle">Monitor de Consumo de Modelo IA - 8h/d√≠a (4.1‚Ç¨/d√≠a, 0.5‚Ç¨/h)</p>
            <div class="session-indicator" id="sessionIndicator">Sesi√≥n 1 de 2</div>
        </header>

        <div id="alertContainer"></div>

        <div class="dashboard">
            <div class="stat-card">
                <h3>Uso Sesi√≥n Actual (5h)</h3>
                <div class="stat-value" id="totalUsage">0.00%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>
            </div>

            <div class="stat-card">
                <h3>Coste Diario Total</h3>
                <div class="stat-value" id="totalCost">0.00‚Ç¨</div>
                <div class="stat-label">de 4.10‚Ç¨/d√≠a (8h)</div>
            </div>

            <div class="stat-card">
                <h3>Coste Medio/Prompt</h3>
                <div class="stat-value" id="avgCostPerPrompt">0.000‚Ç¨</div>
                <div class="stat-label">todas las sesiones</div>
            </div>

            <div class="stat-card">
                <h3>Total Prompts Hoy</h3>
                <div class="stat-value" id="totalPrompts">0</div>
                <div class="stat-label">todas las sesiones</div>
            </div>

            <div class="stat-card">
                <h3>Uso Medio/Prompt</h3>
                <div class="stat-value" id="avgPerPrompt">0.00%</div>
                <div class="stat-label">sesi√≥n actual</div>
            </div>

            <div class="stat-card">
                <h3>Prompts/Hora</h3>
                <div class="stat-value" id="promptsPerHour">0</div>
                <div class="stat-label">estimados</div>
            </div>

            <div class="stat-card">
                <h3>Minutos/Prompt</h3>
                <div class="stat-value" id="minutesPerPrompt">0</div>
                <div class="stat-label">disponible cada</div>
            </div>
        </div>

        <div class="input-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">Registrar Nuevo Prompt</h2>
            <form id="promptForm">
                <div class="form-group">
                    <label for="currentUsage">Porcentaje de Uso Actual (%):</label>
                    <input
                        type="number"
                        id="currentUsage"
                        step="0.01"
                        min="0"
                        max="100"
                        placeholder="Ej: 15.5"
                        required
                    >
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn-primary">Registrar Prompt</button>
                    <button type="button" class="btn-secondary" onclick="resetSession()">Nueva Sesi√≥n (5h)</button>
                    <button type="button" class="btn-danger" onclick="endDay()">Acabar el D√≠a</button>
                </div>
            </form>
        </div>

        <div class="history-section">
            <h2>Hist√≥rico de Prompts - Sesi√≥n Actual</h2>
            <div style="overflow-x: auto;">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha/Hora</th>
                            <th>Uso Acumulado</th>
                            <th>Consumo Prompt</th>
                            <th>Coste Prompt</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div>
                                    <p style="font-size: 1.2em;">No hay prompts registrados en esta sesi√≥n</p>
                                    <p>Introduce el porcentaje de uso actual para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="weekly-stats" id="weeklyStatsSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Estad√≠sticas Semanales (√öltimos 7 d√≠as)</h2>
                <button class="btn-success" onclick="exportWeeklyData()" style="min-width: auto; flex: none;">
                    üìä Exportar Datos
                </button>
            </div>
            <div id="weeklyStatsContent">
                <div class="empty-state">
                    <p>No hay datos semanales disponibles</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n: 4.1‚Ç¨/d√≠a para 8h de uso, el uso se mide en sesiones de 5h
        const COST_PER_DAY = 4.1;
        const COST_PER_HOUR = 0.5;
        const HOURS_PER_DAY = 8;
        const USAGE_HOURS = 5;
        const COST_PER_PERCENT = COST_PER_HOUR / 100; // 0.5‚Ç¨ / 100% = 0.005‚Ç¨ por punto porcentual

        // Estado actual
        let currentSessionNumber = parseInt(localStorage.getItem('currentSessionNumber')) || 1;
        let currentSessionPrompts = JSON.parse(localStorage.getItem('currentSessionPrompts')) || [];
        let lastUsage = parseFloat(localStorage.getItem('lastUsage')) || 0;
        let dailyCost = parseFloat(localStorage.getItem('dailyCost')) || 0;
        let completedSessions = JSON.parse(localStorage.getItem('completedSessions')) || [];
        let dailyHistory = JSON.parse(localStorage.getItem('dailyHistory')) || [];

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        function updateDashboard() {
            // Calcular totales de todas las sesiones del d√≠a
            let allPromptsToday = [...currentSessionPrompts];
            completedSessions.forEach(session => {
                allPromptsToday = allPromptsToday.concat(session.prompts);
            });

            const totalUsageCurrentSession = lastUsage;
            const totalCost = dailyCost;
            const totalPromptsToday = allPromptsToday.length;
            const totalPromptsCurrentSession = currentSessionPrompts.length;

            let avgPerPrompt = 0;
            let avgCostPerPrompt = 0;
            let promptsPerHour = 0;
            let minutesPerPrompt = 0;

            if (totalPromptsCurrentSession > 0) {
                avgPerPrompt = totalUsageCurrentSession / totalPromptsCurrentSession;

                if (avgPerPrompt > 0) {
                    promptsPerHour = Math.floor(100 / avgPerPrompt);
                    minutesPerPrompt = (60 / promptsPerHour).toFixed(1);
                }
            }

            if (totalPromptsToday > 0) {
                avgCostPerPrompt = totalCost / totalPromptsToday;
            }

            document.getElementById('totalUsage').textContent = totalUsageCurrentSession.toFixed(2) + '%';
            document.getElementById('totalCost').textContent = totalCost.toFixed(2) + '‚Ç¨';
            document.getElementById('avgCostPerPrompt').textContent = avgCostPerPrompt.toFixed(3) + '‚Ç¨';
            document.getElementById('totalPrompts').textContent = totalPromptsToday;
            document.getElementById('avgPerPrompt').textContent = avgPerPrompt.toFixed(2) + '%';
            document.getElementById('promptsPerHour').textContent = promptsPerHour;
            document.getElementById('minutesPerPrompt').textContent = minutesPerPrompt;

            document.getElementById('sessionIndicator').textContent = `Sesi√≥n ${currentSessionNumber} de 2`;

            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = Math.min(totalUsageCurrentSession, 100) + '%';
            progressBar.textContent = totalUsageCurrentSession.toFixed(1) + '%';

            if (totalUsageCurrentSession > 90) {
                progressBar.style.background = 'linear-gradient(90deg, #ff4757 0%, #ff3838 100%)';
            } else if (totalUsageCurrentSession > 70) {
                progressBar.style.background = 'linear-gradient(90deg, #ffa502 0%, #ff6348 100%)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
            }
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');

            if (currentSessionPrompts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div>
                                <p style="font-size: 1.2em;">No hay prompts registrados en esta sesi√≥n</p>
                                <p>Introduce el porcentaje de uso actual para comenzar</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = currentSessionPrompts.map((prompt, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${new Date(prompt.timestamp).toLocaleString('es-ES')}</td>
                    <td><strong>${prompt.usage.toFixed(2)}%</strong></td>
                    <td>${prompt.consumed.toFixed(2)}%</td>
                    <td>${prompt.cost.toFixed(3)}‚Ç¨</td>
                    <td>
                        <button class="delete-btn" onclick="deletePrompt(${index})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateWeeklyStats() {
            const content = document.getElementById('weeklyStatsContent');

            if (dailyHistory.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <p>No hay datos semanales disponibles</p>
                        <p>Los datos se guardar√°n al finalizar cada d√≠a</p>
                    </div>
                `;
                return;
            }

            // Calcular estad√≠sticas generales de la semana
            const totalWeeklyCost = dailyHistory.reduce((sum, day) => sum + day.totalCost, 0);
            const totalWeeklyPrompts = dailyHistory.reduce((sum, day) => sum + day.totalPrompts, 0);
            const avgDailyCost = totalWeeklyCost / dailyHistory.length;
            const avgDailyPrompts = totalWeeklyPrompts / dailyHistory.length;

            let statsHTML = `
                <div class="weekly-grid">
                    <div class="stat-card">
                        <h3>Coste Total Semanal</h3>
                        <div class="stat-value">${totalWeeklyCost.toFixed(2)}‚Ç¨</div>
                        <div class="stat-label">${dailyHistory.length} d√≠as registrados</div>
                    </div>
                    <div class="stat-card">
                        <h3>Prompts Totales</h3>
                        <div class="stat-value">${totalWeeklyPrompts}</div>
                        <div class="stat-label">esta semana</div>
                    </div>
                    <div class="stat-card">
                        <h3>Coste Medio Diario</h3>
                        <div class="stat-value">${avgDailyCost.toFixed(2)}‚Ç¨</div>
                        <div class="stat-label">por d√≠a</div>
                    </div>
                    <div class="stat-card">
                        <h3>Prompts Medio Diario</h3>
                        <div class="stat-value">${avgDailyPrompts.toFixed(1)}</div>
                        <div class="stat-label">por d√≠a</div>
                    </div>
                </div>

                <h3 style="color: #667eea; margin: 30px 0 15px 0;">Desglose por D√≠a</h3>
                <div class="weekly-grid">
            `;

            dailyHistory.forEach(day => {
                const date = new Date(day.date);
                const dayName = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                statsHTML += `
                    <div class="day-card">
                        <h4>${dayName} <span class="session-badge">${day.sessions.length} sesiones</span></h4>
                        <div class="day-stat">
                            <span>Coste Total:</span>
                            <strong>${day.totalCost.toFixed(2)}‚Ç¨</strong>
                        </div>
                        <div class="day-stat">
                            <span>Total Prompts:</span>
                            <strong>${day.totalPrompts}</strong>
                        </div>
                        <div class="day-stat">
                            <span>Coste Medio/Prompt:</span>
                            <strong>${day.avgCostPerPrompt.toFixed(3)}‚Ç¨</strong>
                        </div>
                `;

                // Desglose por sesi√≥n
                day.sessions.forEach((session, idx) => {
                    statsHTML += `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                            <div class="day-stat" style="font-size: 0.9em;">
                                <span><strong>Sesi√≥n ${session.sessionNumber}:</strong></span>
                                <span>${session.prompts.length} prompts</span>
                            </div>
                            <div class="day-stat" style="font-size: 0.9em;">
                                <span>Uso Total:</span>
                                <strong>${session.totalUsage.toFixed(2)}%</strong>
                            </div>
                        </div>
                    `;
                });

                statsHTML += `
                    </div>
                `;
            });

            statsHTML += '</div>';
            content.innerHTML = statsHTML;
        }

        function deletePrompt(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este prompt?')) {
                currentSessionPrompts.splice(index, 1);

                // Recalcular lastUsage y dailyCost
                if (currentSessionPrompts.length > 0) {
                    lastUsage = currentSessionPrompts[currentSessionPrompts.length - 1].usage;
                    // Recalcular dailyCost sumando todas las sesiones
                    dailyCost = currentSessionPrompts.reduce((sum, p) => sum + p.cost, 0);
                    completedSessions.forEach(session => {
                        dailyCost += session.prompts.reduce((sum, p) => sum + p.cost, 0);
                    });
                } else {
                    lastUsage = 0;
                    // Recalcular solo con sesiones completadas
                    dailyCost = 0;
                    completedSessions.forEach(session => {
                        dailyCost += session.prompts.reduce((sum, p) => sum + p.cost, 0);
                    });
                }

                saveData();
                updateDashboard();
                updateHistoryTable();
                showAlert('Prompt eliminado correctamente', 'success');
            }
        }

        document.getElementById('promptForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const currentUsage = parseFloat(document.getElementById('currentUsage').value);

            if (isNaN(currentUsage) || currentUsage < 0 || currentUsage > 100) {
                showAlert('Por favor, introduce un porcentaje v√°lido entre 0 y 100', 'danger');
                return;
            }

            if (currentUsage < lastUsage) {
                showAlert('El porcentaje actual no puede ser menor al anterior (' + lastUsage.toFixed(2) + '%)', 'warning');
                return;
            }

            const consumed = currentUsage - lastUsage;
            const cost = consumed * COST_PER_PERCENT;

            const newPrompt = {
                timestamp: new Date().toISOString(),
                usage: currentUsage,
                consumed: consumed,
                cost: cost
            };

            currentSessionPrompts.push(newPrompt);
            lastUsage = currentUsage;
            dailyCost += cost;

            saveData();
            updateDashboard();
            updateHistoryTable();

            document.getElementById('currentUsage').value = '';

            showAlert(`Prompt registrado: ${consumed.toFixed(2)}% consumido (${cost.toFixed(3)}‚Ç¨)`, 'success');
        });

        function saveData() {
            localStorage.setItem('currentSessionNumber', currentSessionNumber.toString());
            localStorage.setItem('currentSessionPrompts', JSON.stringify(currentSessionPrompts));
            localStorage.setItem('lastUsage', lastUsage.toString());
            localStorage.setItem('dailyCost', dailyCost.toString());
            localStorage.setItem('completedSessions', JSON.stringify(completedSessions));
            localStorage.setItem('dailyHistory', JSON.stringify(dailyHistory));
        }

        function resetSession() {
            if (currentSessionPrompts.length === 0) {
                showAlert('No hay datos en la sesi√≥n actual para guardar', 'warning');
                return;
            }

            if (confirm('¬øIniciar nueva sesi√≥n? Esto guardar√° la sesi√≥n actual internamente y comenzar√° una nueva sesi√≥n de 5h.')) {
                // Guardar la sesi√≥n actual en completedSessions
                const sessionData = {
                    sessionNumber: currentSessionNumber,
                    startTime: currentSessionPrompts[0].timestamp,
                    endTime: currentSessionPrompts[currentSessionPrompts.length - 1].timestamp,
                    totalUsage: lastUsage,
                    prompts: currentSessionPrompts
                };

                completedSessions.push(sessionData);

                // Limpiar para nueva sesi√≥n
                currentSessionNumber++;
                currentSessionPrompts = [];
                lastUsage = 0;
                // dailyCost se mantiene

                saveData();
                updateDashboard();
                updateHistoryTable();

                showAlert(`Sesi√≥n ${sessionData.sessionNumber} guardada. Ahora en Sesi√≥n ${currentSessionNumber}. Coste diario: ${dailyCost.toFixed(2)}‚Ç¨`, 'success');
            }
        }

        function endDay() {
            // Verificar si hay datos para guardar
            const hasCurrentSessionData = currentSessionPrompts.length > 0;
            const hasCompletedSessions = completedSessions.length > 0;

            if (!hasCurrentSessionData && !hasCompletedSessions && dailyCost === 0) {
                showAlert('No hay datos para guardar del d√≠a de hoy', 'warning');
                return;
            }

            if (confirm('¬øAcabar el d√≠a? Esto guardar√° todas las sesiones de hoy en las estad√≠sticas semanales y comenzar√° un nuevo d√≠a.')) {
                // Guardar sesi√≥n actual si tiene datos
                let allSessions = [...completedSessions];
                if (hasCurrentSessionData) {
                    const currentSessionData = {
                        sessionNumber: currentSessionNumber,
                        startTime: currentSessionPrompts[0].timestamp,
                        endTime: currentSessionPrompts[currentSessionPrompts.length - 1].timestamp,
                        totalUsage: lastUsage,
                        prompts: currentSessionPrompts
                    };
                    allSessions.push(currentSessionData);
                }

                // Calcular totales del d√≠a
                let allPromptsDay = [];
                allSessions.forEach(session => {
                    allPromptsDay = allPromptsDay.concat(session.prompts);
                });

                const today = new Date().toISOString().split('T')[0];

                const dayData = {
                    date: today,
                    totalCost: dailyCost,
                    totalPrompts: allPromptsDay.length,
                    avgCostPerPrompt: allPromptsDay.length > 0 ? dailyCost / allPromptsDay.length : 0,
                    sessions: allSessions
                };

                // A√±adir al historial (mantener solo √∫ltimos 7 d√≠as)
                dailyHistory.unshift(dayData);
                if (dailyHistory.length > 7) {
                    dailyHistory = dailyHistory.slice(0, 7);
                }

                // Resetear d√≠a
                currentSessionNumber = 1;
                currentSessionPrompts = [];
                lastUsage = 0;
                dailyCost = 0;
                completedSessions = [];

                saveData();
                updateDashboard();
                updateHistoryTable();
                updateWeeklyStats();

                showAlert(`D√≠a finalizado. ${allSessions.length} sesiones guardadas con ${allPromptsDay.length} prompts totales. ¬°Nuevo d√≠a comenzado!`, 'success');
            }
        }

        function exportWeeklyData() {
            if (dailyHistory.length === 0) {
                showAlert('No hay datos para exportar', 'warning');
                return;
            }

            // Preparar datos para exportaci√≥n
            const exportData = {
                exportDate: new Date().toISOString(),
                summary: {
                    totalDays: dailyHistory.length,
                    totalCost: dailyHistory.reduce((sum, day) => sum + day.totalCost, 0),
                    totalPrompts: dailyHistory.reduce((sum, day) => sum + day.totalPrompts, 0),
                    avgDailyCost: dailyHistory.reduce((sum, day) => sum + day.totalCost, 0) / dailyHistory.length,
                    avgDailyPrompts: dailyHistory.reduce((sum, day) => sum + day.totalPrompts, 0) / dailyHistory.length
                },
                dailyData: dailyHistory
            };

            // Crear archivo JSON
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            // Crear link de descarga
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-usage-stats-${new Date().toISOString().split('T')[0]}.json`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showAlert('Datos exportados correctamente en formato JSON', 'success');
        }

        // Inicializar la aplicaci√≥n
        updateDashboard();
        updateHistoryTable();
        updateWeeklyStats();
    </script>
</body>
</html>
